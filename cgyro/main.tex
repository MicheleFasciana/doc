\documentclass[11pt]{article}
\usepackage{latexsym}
\usepackage{amsfonts}
\usepackage{amsmath}
\usepackage{epsfig}
\usepackage{fancyhdr}
\usepackage{fullpage}
\usepackage{hyperref}
\hypersetup{
    unicode=false,          % non-Latin characters in Acrobat’s bookmarks
    pdftoolbar=true,        % show Acrobat’s toolbar?
    pdfmenubar=true,        % show Acrobat’s menu?
    pdffitwindow=false,     % window fit to page when opened
    pdfstartview={FitH},    % fits the width of the page to the window
    pdftitle={GYRO Technical Guide},    % title
    pdfauthor={J. Candy},     % author
    pdfsubject={},   % subject of the document
    pdfcreator={},   % creator of the document
    pdfproducer={}, % producer of the document
    pdfkeywords={}, % list of keywords
    pdfnewwindow=false,      % links in new window
    colorlinks=true,        % false: boxed links; true: colored links
    linkcolor=red,          % color of internal links
    citecolor=blue,         % color of links to bibliography
    filecolor=magenta,      % color of file links
    urlcolor=red           % color of external links
}

\pagestyle{fancy}
\renewcommand{\headrulewidth}{0pt} % remove lines as well

\input macros

\lhead{}
\rhead{}

\lfoot{General Atomics Report GA-AXXXXX}
\cfoot{}
\rfoot{\hfill\thepage}

\setlength{\textheight}{9in}

\makeindex

\begin{document}

%TITLE=====================================================
\title{{\LARGE\bf CGYRO Technical Guide}}
\author{J. Candy and E. Belli \\
{\small General Atomics, P.O.~Box 85608, San Diego, CA 92186-5608, USA}}
\maketitle
%TITLE=====================================================

\begin{abstract}
We describe the spectral configuration-space and pseudospectral velocity-space
algorithms implemented in the new CGYRO code. 
\end{abstract}

\section{Coordinates}
We begin by considering the formulation of the gyrokinetic equations in 
$(\psi,\theta,\varphi, \xi, \varepsilon)$ coordinates.  Here the velocity-space
coordinates are the cosine of the pitch angle, $\xi \doteq \vp/v$, and the
kinetic energy per unit mass, $\varepsilon = v^2/2$. For the spatial 
dimensions, we adopt the standard field-aligned coordinate system
$(\psi,\theta,\varphi)$, where $\psi$ is the poloidal flux divided by 
$2 \pi$, $\theta$ is an angle in the poloidal plane, and $\varphi$ is 
the toroidal angle.  In these coordinates, we write the magnetic field as
%
\begin{equation}
\B = \nabla\varphi\times\nabla\psi + I(\psi) \nabla\varphi \; ,
\end{equation}
%
where $B_t = I(\psi)/R$ is the toroidal field strength and 
$B_p = |\nabla\psi|/R$ is the poloidal field strength. The Jacobian 
determinant $\jp$ satisfies
$\jp^{-1} \doteq  {\nabla\psi\times\nabla\theta\cdot\nabla\varphi}$.  We
also define a spatial coordinate $r$ which measure the half-width of 
the flux-surface at the height of the centroid.  This label has 
dimensions of length, and for an up-down symmetric flux-surface, 
$r$ is just the usual midplane minor radius.  $\psi^\prime$ is defined as
$\partial \psi / \partial r$.  The {\sl effective magnetic field}, 
$B_{unit}$ \cite{candy:2009b}, is defined with reference to a global 
equilibrium through the relation $\psi^\prime = (r/q) B_{unit}$.  
Unlike the field strength, $B(\psi,\theta$, the effective field 
$B_{unit}$ is constant on a flux surface.

\newpage

\section{The Gyrokinetic Equation}

The gyrokinetic equation for species $a$ takes the form
%
\begin{equation}
\frac{\partial h_a}{\partial t}
- i \left( \omega_{\theta} + \omega_{\rm \xi} + \omega_{\rm d} \right) H_a
  + c [f_{0a} + h_a , \Psi_a ] = C_a^{L}\left\{h\right\} \; ,
\label{gkeqn}
\end{equation}
%
where $\Psi_a$ is the field potential:
%
\begin{equation}
\Psi_a \doteq G_{0a} \left( \delta \phi - \frac{\vp}{c} \dap \right)
         + \frac{v_\perp^2}{\Omega_{ca} c} G_{1a} \dbp \; ,
\end{equation}
%
In this potential, $G_{0a}$ and $G_{1a}$ are linear operators arising from 
gyro-averaging \cite{sugama:1998}, and $H_a$ is the {\sl non-adiabatic distribution} 
%
\begin{equation}
H_a \doteq h_a + \frac{z_a e f_{0a}}{T_a} \Psi_a \; .
\end{equation}
%
Above, $f_{0a}$ is the zeroth-order distribution function, which has the 
Maxwellian form
%
\begin{equation}
f_{0a} = \frac{n_a}{(2 \pi \vta^2)^{3/2}} e^{-x_a^2} \; ,
\end{equation}
%
where $x_a \doteq v/(\sqrt{2} \, \vta)$ and $\vta \doteq \sqrt{T_a/m_a}$ 
is the thermal speed.  The Poisson bracket has also been used, according 
to the convention
%
\begin{equation}
[f,g] \doteq 
 \frac{\partial f}{\partial \psi}\frac{\partial g}{\partial \alpha} 
-\frac{\partial g}{\partial \psi}\frac{\partial f}{\partial \alpha} \; .
\end{equation}
%
where $\alpha \doteq \varphi + \nu(\psi,\theta)$ is explained in more detail 
in the GYRO technical manual.
Above, the subscript $a$ denotes the species index.  In Eq.(\ref{gkeqn}), we 
have defined the {\sl parallel streaming} operator
%
\begin{equation}
-i \omega_{\theta} = v \, \frac{\xi}{\jp B}  
\frac{\partial}{\partial \theta} \; ,
\end{equation}
%
and the {\sl trapping} operator
%
\begin{equation}
-i \omega_{\xi} = v \, \frac{1-\xi^2}{\jp B} 
\frac{\partial \ln B}{\partial \theta}
  \frac{\partial}{\partial \xi} \; . 
\end{equation}
%
The trapping opeartor appears when using the $(\xi,\varepsilon)$ velocity-space 
coordinates.  It is absent in GYRO.  Also, we have the {\sl radial drift} operator 
including the pressure-gradient drift
%
\begin{equation}
- i \omega_{\rm d} = \frac{v^2}{2} \frac{1 + \xi^2}{\Omega_{ca}} 
  \frac{\bhat \times \nabla B}{B} \cdot \nabla_\perp 
  + \frac{v^2}{2} \frac{\xi^2}{\Omega_{ca}} \frac{8\pi}{B^2} \, \frac{dp}{dr} 
  (\bhat \times \nabla r) \cdot \nabla_\perp \; ,
\end{equation}
%  
where $\Omega_{ca} \doteq (z_a e B)/(m_a c)$ is the cyclotron frequency.
The corresponding gyrokinetic-Maxwell equations are given by
%
\begin{eqnarray}
-\frac{1}{4 \pi} \nabla_{\perp}^{2} \dphi + \sum_a
 \frac{z_a^2 e^2}{T_a} \int \dv \, f_{0a} \dphi
&=& \sum_{a} z_a e \int \dv \, {\cal G}_{0a} H_a \; ,
 \label{gk_phi} \\
 -\frac{1}{4 \pi} \nabla_{\perp}^{2} \dap
&=& \sum_{a} z_a e \int \dv \, \frac{\vp}{c} \, {\cal G}_{0a} H_{a} \; ,
\label{gk_apar}  \\
-\frac{1}{4 \pi} \dbp
&=& \sum_{a} z_a e  \int \dv \,
 \frac{v_{\perp}^{2}}{\Omega_{ca} c} \, {\cal G}_{1a} H_{a} \; .
\label{gk_bpar}
\end{eqnarray}

\subsection{Fully spectral form}

Introducing a periodic radial variable $x \in [0,2\pi) \doteq 2 \pi r/L$, we can 
write normalized spectral coefficients via
%
\begin{eqnarray}
\frac{h_a}{f_{0a}} & = & \sum_{n=-\np}^{\np} 
                    \sum_{p=-\nr/2}^{\nr/2-1} h_n^p e^{ipx} e^{-in\alpha} \\
\frac{e \Psi_a}{T_{\rm norm}} & = &  \sum_{n=-\np}^{\np} 
                    \sum_{p=-\nr/2}^{\nr/2-1} \Psi_n^p e^{ipx} e^{-in\alpha} 
\end{eqnarray}
%
In the discrete case we will take $x_j = 2\pi r_j/L = 2\pi j/\nr$ 
and $\alpha_k = 2\pi k/\np$.  Then the spectral GK equation is
%
\begin{equation}
\frac{\partial h_n^p}{\partial \tau}
- i \left( \Omega_{\theta} + \Omega_{\rm \xi} + \Omega_{\rm d} \right) H_n^p
  - i \Omega_* \Psi_n^p + \frac{2\pi a}{L} \frac{q \rho}{r}
   [h,\Psi]_n^p = C_a^{L}\left\{h\right\} \; ,
\label{ngkeqn}
\end{equation}
%
such that the streaming and trapping operators are
%
\begin{eqnarray}
-i \Omega_{\theta} &=& \frac{v}{\vn} \xi \frac{a}{\jp B}  
\frac{\partial}{\partial \theta} \; , \\
-i \Omega_{\xi} &=& \frac{v}{\vn} (1-\xi^2)
\frac{a}{\jp B} \frac{\partial \ln B}{\partial \theta}
  \frac{\partial}{\partial \xi} \; .
\end{eqnarray}
%
The drift operator is complicated and cannot be written in terms of simple 
functions for a shaped plasma.  We write it as
%
\begin{equation}
\frac{\vn}{a} \, \Omega_{\rm d} =  
 \frac{v^2}{2} \frac{1 + \xi^2}{R_0 \Omega_{ca}} \left( 
  {\rm gsin} \, k_x + {\rm gcos} \, k_y \right) 
 + \frac{v^2}{2} \frac{\xi^2}{R_0 \Omega_{ca}} 
\frac{\bunit^2}{B^2} |\nabla r| \beta_* k_y \; .
\end{equation}
%
Finally, the gradient drive is represented by
\begin{equation}
- i \Omega_{*} = i k_{\theta} \rho \left[ \frac{1}{L_{na}} + \frac{1}{L_{Ta}}
\left( x_a^2 - \frac{3}{2} \right) \right] \; .
\end{equation}
%
Above, we have defined the equilibrium density and temperature length 
scales as
% 
\begin{equation}
\frac{1}{L_{na}}\doteq -\frac{1}{n_a}\frac{d n_a}{dr} 
\quad\mathrm{and}\quad
\frac{1}{L_{Ta}} \doteq -\frac{1}{T_a}\frac{d T_a}{dr} \; .
\end{equation} 
%
Further, we ahve introduced a pair of wavenumbers $(k_x,k_y)$  which, in real 
space, are operators defined by
%
\begin{eqnarray}
i k_x &\rightarrow& \ex \cdot \nabla_\perp = |\nabla r| \frac{\partial}{\partial r} 
- \frac{q}{r} G_q \Theta \frac{\partial}{\partial \alpha} \; , \\
i k_y &\rightarrow& \ey \cdot \nabla_\perp = 
- \frac{q}{r} G_q \frac{\partial}{\partial \alpha} \; .
\end{eqnarray}
%
According to the spectral expansion, we have
%
\begin{eqnarray}
k_x &=& 2\pi p \, \frac{|\nabla r|}{L} + G_q \Theta k_\theta \; , \\
k_y &=& G_q k_\theta \; .
\end{eqnarray}
%
The gyroaverage and Laplacian are written compactly in terms of these wavenumbers as
%
\begin{eqnarray}
{\cal G}_{0a} &\rightarrow& J_0\left(\frac{k_\perp v_\perp}{\Omega_{ca}}\right) \; , \\
\nabla_\perp^2 &\rightarrow& - k_\perp^2 \; ,
\end{eqnarray}
%
where $k_\perp^2 = k_x^2+k_y^2$.  Using these identities, it is trivial to write the 
field equations in spectral form.  The spectral representation of the Poisson 
bracket is
%
\begin{equation}
[f,g]_n^p \doteq \sum_{\pp} \sum_{\nn}  f_{\nnn}^{\ppp} \, 
g_{\nn}^{\pp} \left( \nnn \pp - \nn \ppp \right) \; ,
\end{equation}
%
where the sums are suitably restricted to acceptable values of the indices.  To evolve the 
nonlinear gyrokinetic equations, the Poisson bracket must be treated carefully.  It is 
well-known that for stable time-integration, {\it dealiasing} is required.  That is, 
we must zero-pad the representations of $f$ and $g$ before taking the product. 

\subsection{Periodicity Condition}
The $\theta$-periodicity condition on physical, real-space functions requires 
that
%
\begin{equation}
X_n(r,\theta) = 
 X_n(r,\theta + 2 \pi) e^{2 \pi i n q(r)} = 
 X_n(r,\theta + 2 \pi) e^{2 \pi i n q_0} e^{i n M x}\; .
\end{equation}
%
where we have quantized the box length via $L = M L_0$ into an integer 
multiple of the natural box length $L_0 = r_0/(qs)$.  While this condition 
is simple to implement in $r$-space, it is more complicated in $p$-space.
Generally, we have
\begin{equation}
\sum_p e^{2\pi i p j/n_r} X_n^p(\theta) = e^{2\pi i n q_0}
\sum_p e^{2\pi i p j/n_r}e^{2\pi i n M j/n_r} X_n^p(\theta+2\pi)
\end{equation}
%
which gives rise to the periodicity condition
%
\begin{equation}
X_n^p(\theta) = e^{2\pi i n q_0} X_n^{p-nM}(\theta+2\pi) \; .
\end{equation}
%
Note that this formula considers $p-nM$ to be $(p-nM) \mod n_r$.

\subsection{Simple Limiting Form of the Equations}

For illustrative purposes, we write the gyrokinetic equation in the limit 
unshifted circular flux surfaces with $R =  R_0 + r \cos \theta$, magnetic 
field variation $B = B_0 / (1 + \epsilon \cos \theta)$ (where $\epsilon=r/R_0$), 
and constant flux function $I = R_0 B_0$.  We also consider the 
electrostatic limit and a simple Lorentz collision operator.  In 
these limits, the gyrokinetic equation simplifies as follows:

\begin{eqnarray}
& & \frac{\partial h}{\partial t}
%
+ v \frac{\xi}{\lp} \frac{\partial H}{\partial \theta}
%
- \frac{v}{2} \frac{1-\xi^2}{\lp} \epsilon \sin \theta
  \frac{\partial H}{\partial \xi}
%
- i \frac{1 + \xi^2}{2}
\frac{v^2}{\vta}
\left(k_\theta \rho_{*a} \cos \theta + k_x \rho_{*a} \sin \theta \right) H
\quad \nonumber \\ 
& & \quad
%
- i \Omega_{*a} J_0 \dphi
= \frac{\nu_{a}(v)}{2} \frac{\partial}{\partial \xi} 
(1-\xi^2) \frac{\partial H}{\partial \xi} \; ,
\end{eqnarray}
%
where $\rho_{*a} = \rho_{a0} / R_0$ with $\rho_{a0} = v_{ta} / \Omega_{ca0}$,
$\Omega_{ca0} = (z_a e B_0) / (m_a c)$ and $\lp = q_0 R_0$ the 
effective length along a fieldline, and $k_x = 2\pi p/L + s\theta k_\theta$.

\subsection{Discontinuity issue}
The streaming terms have the form
%
\begin{equation}
\dot{\theta} \frac{\partial}{\partial\theta} + 
\dot{\xi} \frac{\partial}{\partial\xi} \; ,
\end{equation}
%
where 
\begin{equation}
\dot{\theta} = \frac{v}{L_\parallel} \xi 
\quad\mathrm{and}\quad
\dot{\xi} = \frac{v}{L_\parallel} \frac{1-\xi^2}{2} \epsilon \sin \theta \; ,
\end{equation}
This can be combined into a single equation 
\begin{equation}
\ddot{\theta} = \left(\frac{v}{L_\parallel}\right)^2 \frac{1-{\dot\theta}^2}{2} 
\epsilon \sin \theta
\end{equation} 
Treating $\epsilon$ as a small parameter (the limit in which the simplified 
equations are valid), the characteristics of the streaming terms have the 
associated integral of motion
\begin{equation}
{\dot\theta}^2 = \dot\theta_0^2 + (1-\dot\theta_0^2) \epsilon\cos\theta \; .
\end{equation}
Evidently, this is the equation of motion of a pendulum.  Without collisions,
there is no mechanism to ensure that the distribution of particles is 
continuous between passing (rotation) and trapped (oscillation) particles.
Thus, we expect that operator splitting may be problematic as the collisionless 
step generates this discontinuity.


\section*{Acknowledgements}

This research was supported by the U.S.\ Department of
Energy under Grant DE-FG03-95ER54309 and by the Edge Simulation Laboratory
project under Grant DE-FC02-06ER54873.

\bibliographystyle{alpha}
\bibliography{global}

\end{document}

